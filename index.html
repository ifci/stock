<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>Title</title>
    <style>*{margin: 0;padding: 0}</style>
</head>
<body>
    <div style="padding: 10px"><canvas id="myCanvas" height="200"></canvas></div>

    <script type="text/javascript">
        fetch({
            url: 'https://vip-service.bankuang.com/TheTimeTrend.php?symbol=SZ002024&r_type=2',
            success: function(data){
                var fsCharts = new Charts('#myCanvas', {
                    data: data
                });
            }
        });
        function Charts(selector, config){
            this.config = config || {};
            this.selector = selector;
            this.init();
        }
        Charts.prototype.init = function(){
            var c = document.querySelector(this.selector);
            c.width = document.body.clientWidth - 20;
            this.ctx=c.getContext("2d");
            this.cWidth = c.width;
            this.cHeight = c.height - 20;
            this.frame();
            this.scale();
            this.polyline();
            this.volume();
            this.hover();
        };
        Charts.prototype.frame = function(){
            /* 线框 */
            this.ctx.beginPath();
            this.ctx.strokeStyle = "rgba(204, 204, 204, 1)";
            this.ctx.strokeRect(0, 0, this.cWidth-0.5, this.cHeight-0.5);
            this.ctx.lineWidth = 0.5;
            this.ctx.moveTo(0, this.cHeight*0.325);
            this.ctx.lineTo(this.cWidth, this.cHeight*0.325);
            this.ctx.moveTo(0, this.cHeight*0.825);
            this.ctx.lineTo(this.cWidth, this.cHeight*0.825);
            this.ctx.moveTo(this.cWidth/4-0.5, 0);
            this.ctx.lineTo(this.cWidth/4-0.5, this.cHeight-0.5);
            this.ctx.moveTo(this.cWidth/2-0.5, 0);
            this.ctx.lineTo(this.cWidth/2-0.5, this.cHeight-0.5);
            this.ctx.moveTo(this.cWidth/4*3-0.5, 0);
            this.ctx.lineTo(this.cWidth/4*3-0.5, this.cHeight-0.5);
            this.ctx.stroke();
        };
        Charts.prototype.scale = function(){
            /* 数值刻度 */
            this.ctx.font = '16px Georgia';
            this.ctx.fillStyle = '#666';
            // 时间刻度
            this.ctx.fillText('09:30', 0, this.cHeight + 14);
            this.ctx.fillText('11:30', this.cWidth / 2 - 17, this.cHeight + 14);
            this.ctx.fillText('15:00', this.cWidth - 40, this.cHeight + 14);

            var max = Math.max.apply(null, this.timeTrend());
            // 上次收盘价
            var lastClose = this.config.data[0].LastClose;
            var min = (lastClose - (max - lastClose)).toFixed(2);
            // 最大值
            this.ctx.fillText(max.toString(), 2, 12);

            // 中间值
            this.ctx.fillText(lastClose, 2, this.cHeight * 0.325 + 3);

            // 最小值
            this.ctx.fillText(min, 2, this.cHeight * 0.65 - 5);

            // 百分比中间值
            this.ctx.fillText('0.00%', this.cWidth - 50, this.cHeight * 0.325 + 3);

            // 百分比最大值
            var percentage = ((max - lastClose) / lastClose * 100).toFixed(2);
            this.ctx.fillText(percentage + '%', this.cWidth - 50, 13);

            // 百分比最小值
            this.ctx.fillText(-percentage + '%', this.cWidth - 54, this.cHeight * 0.65 - 3);

            this.ctx.font = '12px Arial';
            // 成交量、成交额
            this.ctx.fillText('量: ', 3, this.cHeight * 0.65 + 13);
            // 最新一条数据
            var latest = this.config.data[this.config.data.length - 1];
            var volume = this.process(latest.Volume);
            this.ctx.fillText(volume, 22, this.cHeight * 0.65 + 13);
            // 成交量数字宽度
            var volumeWidth = this.ctx.measureText(this.process(this.config.data[this.config.data.length - 1].Volume)).width;
            this.ctx.fillText('额: ', 28 + volumeWidth, this.cHeight * 0.65 + 13);
            this.ctx.fillText(this.process(latest.Amount), 48 + volumeWidth, this.cHeight * 0.65 + 13);
        };
        Charts.prototype.timeTrend = function(){    // 成交价
            var arr = [];
            this.config.data.map(function(v, i){
                arr.push(v.TimeTrend)
            });
            return arr;
        };
        Charts.prototype.volumeArr = function(){    // 成交量
            var arr = [];
            this.config.data.map(function(v, i){
                arr.push(v.Volume)
            });
            return arr;
        };
        Charts.prototype.polyline = function(){
            var _self = this;
            var max = Math.max.apply(null, this.timeTrend());
            // 上次收盘价
            var lastClose = this.config.data[0].LastClose;
            var min = (lastClose - (max - lastClose)).toFixed(2);
            var firstTrend = (((this.config.data[0].TimeTrend * 100 - min * 100)/100) / ((max * 100 - min * 100)/100)).toFixed(2);
            var fPoint = this.cHeight * 0.65 * (1 - firstTrend);
            var fWidth = this.cWidth/240;
            _self.ctx.beginPath();
            _self.ctx.strokeStyle = "#1FA3C9";
            _self.ctx.moveTo(0, fPoint);
            _self.config.data.map(function(v, i){
//                console.log(this.cWidth/240)
                var iTrend = (((v.TimeTrend * 100 - min * 100)/100) / ((max * 100 - min * 100)/100)).toFixed(2);
                var iPoint = _self.cHeight * 0.65 * (1 - iTrend);
                _self.ctx.lineTo(fWidth * (i + 1), iPoint);
            });
            _self.ctx.lineTo(fWidth * _self.config.data.length, _self.cHeight * 0.65-0.5);
            _self.ctx.lineTo(0, _self.cHeight * 0.65-0.5);
            _self.ctx.fillStyle = 'rgba(34, 164, 202, .1)';
            _self.ctx.fill();
            _self.ctx.stroke();

            _self.ctx.beginPath();
            _self.ctx.strokeStyle = '#cccccc';
            _self.ctx.lineWidth = 1;
            _self.ctx.moveTo(0, _self.cHeight*0.65 - 0.5);
            _self.ctx.lineTo(_self.cWidth, _self.cHeight*0.65 - 0.5);
            _self.ctx.stroke();
        };

        /* 成交量柱形图 */
        Charts.prototype.volume = function(){
            var _self = this;
            var fWidth = this.cWidth/240;
            // 成交量最大值
            var maxVolume = Math.max.apply(null, _self.volumeArr());
            // 柱形图起点
            var vHeight = this.cHeight * 0.65 + 18 + 0.5;
            // 柱形图总高度
            var aHeight = this.cHeight - vHeight;
            _self.config.data.map(function(v, i){
                _self.ctx.beginPath();
                _self.ctx.strokeStyle =  v.TimeTrend >= v.LastClose ? "#d85342" : "#6ca584";
                _self.ctx.moveTo(fWidth * (i + 1), (maxVolume - v.Volume)/maxVolume * aHeight + vHeight-0.5);
                _self.ctx.lineTo(fWidth * (i + 1), _self.cHeight);
                _self.ctx.stroke();
            })
        };

        Charts.prototype.process = function(value){
            if(value){
                if(!isNaN(value)){
                    value = parseInt(value);
                    var len = parseInt(Math.abs(value)).toString().length;
                    value = (len > 8 && (value / 100000000)) || (len > 4 && (value / 10000)) || value;
                    if(value.toString().indexOf('.') !== -1){
                        value = value.toFixed(2)
                    }
                    value = (len > 8 && value + '亿') || (len > 4 && value + '万') || value
                }
            }else{
                value = '0';
            }
            return value;
        };

        /* 鼠标事件 */
        Charts.prototype.hover = function(){
            var ele = document.querySelector(this.selector);
            var _self = this;
            ele.addEventListener('touchmove', function(e){
                var touchX = e.touches[0].clientX;
                var touchY = e.touches[0].clientY;
                if(touchX > 10 && touchX < 350 && touchY > 10 && touchY < 190){
                    // 竖的虚线
                    _self.ctx.moveTo(0, 0);
                    _self.ctx.lineTo(0, 0);
                    _self.ctx.dashedLineTo(150.5, 0, 150.5, 250, 4);
                    _self.ctx.stroke();
                    console.log(touchX + ' + ' + touchY)
                }
            })
        };
        CanvasRenderingContext2D.prototype.dashedLineTo = function (fromX, fromY, toX, toY, pattern) {
            // default interval distance -> 5px
            if (typeof pattern === "undefined") {
                pattern = 5;
            }

            // calculate the delta x and delta y
            var dx = (toX - fromX);
            var dy = (toY - fromY);
            var distance = Math.floor(Math.sqrt(dx*dx + dy*dy));
            var dashlineInteveral = (pattern <= 0) ? distance : (distance/pattern);
            var deltay = (dy/distance) * pattern;
            var deltax = (dx/distance) * pattern;

            // draw dash line
            this.beginPath();
            for(var dl=0; dl<dashlineInteveral; dl++) {
                if(dl%2) {
                    this.lineTo(fromX + dl*deltax, fromY + dl*deltay);
                } else {
                    this.moveTo(fromX + dl*deltax, fromY + dl*deltay);
                }
            }
            this.stroke();
        };

        /* ajax方法 */
        function fetch(obj){
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    obj.success(JSON.parse(xhr.responseText));
                }
            };
            xhr.open("GET", obj.url);
            xhr.send();
        }
    </script>
</body>
</html>